services:
  app:
    build: .
    image: pt-af-pro-api-tools
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # PTAF connection (NO SECRETS here â€“ example values only)
      AF_URL: "https://ptaf.example.com"
      API_PATH: "/api/ptaf/v4"

      # SSL verification: "true" / "false" or path to CA bundle
      VERIFY_SSL: "true"

      # Logging
      LOG_LEVEL: "INFO"

      # Choose ONE auth method:
      #  1) Static token via Docker secret:
      #     API_TOKEN_FILE=/run/secrets/ptaf_api_token
      #  2) Username/password via Docker secrets:
      #     API_LOGIN_FILE=/run/secrets/ptaf_api_login
      #     API_PASSWORD_FILE=/run/secrets/ptaf_api_password

      # Example: enable username/password auth using secrets:
      API_LOGIN_FILE: "/run/secrets/ptaf_api_login"
      API_PASSWORD_FILE: "/run/secrets/ptaf_api_password"
      # API_TOKEN_FILE: "/run/secrets/ptaf_api_token"

    secrets:
      - ptaf_api_login
      - ptaf_api_password
      # - ptaf_api_token

    volumes:
      - ./snapshots:/app/snapshots

  init-snapshots:
    image: pt-af-pro-api-tools
    restart: "no"
    depends_on:
      - app
    command: ["python", "init_snapshots.py"]
    environment:
      AF_URL: "https://ptaf.example.com"
      API_PATH: "/api/ptaf/v4"
      VERIFY_SSL: "true"
      LOG_LEVEL: "INFO"
      API_LOGIN_FILE: "/run/secrets/ptaf_api_login"
      API_PASSWORD_FILE: "/run/secrets/ptaf_api_password"
      # API_TOKEN_FILE: "/run/secrets/ptaf_api_token"
    secrets:
      - ptaf_api_login
      - ptaf_api_password
      # - ptaf_api_token
    volumes:
      - ./snapshots:/app/snapshots

secrets:
  ptaf_api_login:
    file: ./secrets/ptaf_api_login.txt
  ptaf_api_password:
    file: ./secrets/ptaf_api_password.txt
  ptaf_api_token:
    file: ./secrets/ptaf_api_token.txt
