services:
  app:
    build: .
    image: pt-af-pro-api-tools
    restart: unless-stopped
    env_file: .env
    ports:
      - "8000:8000"
    user: "${UID}:${GID}"
    secrets:
      - ptaf_api_login
      - ptaf_api_password
      # - ptaf_api_token

    volumes:
      - ./modules:/home/app/modules
      - ./init_snapshots.py:/home/app/init_snapshots.py
      - ./snapshots:/home/app/snapshots

  init-snapshots:
    image: pt-af-pro-api-tools
    restart: "no"
    env_file: .env
    user: "${UID}:${GID}"
    depends_on:
      - app
    command: ["python", "init_snapshots.py"]

    secrets:
      - ptaf_api_login
      - ptaf_api_password
      # - ptaf_api_token
    volumes:
      - ./modules:/home/app/modules
      - ./init_snapshots.py:/home/app/init_snapshots.py
      - ./snapshots:/home/app/snapshots

secrets:
  ptaf_api_login:
    file: ./secrets/ptaf_api_login.txt
  ptaf_api_password:
    file: ./secrets/ptaf_api_password.txt
  ptaf_api_token:
    file: ./secrets/ptaf_api_token.txt
